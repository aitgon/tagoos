ROADMAP_DATA_DIR = os.getenv('ROADMAP_DATA_DIR')
ROADMAP_URL_LIST = os.getenv('ROADMAP_URL_LIST')
THREADS = int(os.getenv('THREADS'))

rule sort_bed:
    input:
        bed = os.path.join(ROADMAP_DATA_DIR, "roadmap_nonsorted.bed"),
    output:
        bed = os.path.join(ROADMAP_DATA_DIR, "roadmap.bed"),
    threads: THREADS
    shell:
        """sort --parallel {threads} -k1,1 -k2,2n {input.bed} -o {output.bed}"""

rule join:
    input:
        pre_sortedk5_bed = os.path.join(ROADMAP_DATA_DIR, "roadmap_pre_sortedk5.bed"),
        cell_type_sorted_tsv=os.path.join(ROADMAP_DATA_DIR, "cell_types_sorted.tsv"),
    output:
        bed = os.path.join(ROADMAP_DATA_DIR, "roadmap_nonsorted.bed"),
    shell:
        """join -1 5 -2 1 -o 1.1,1.2,1.3,1.4,2.2,1.6 {input.pre_sortedk5_bed} {input.cell_type_sorted_tsv} |sed 's/ DNase / DNase-seq /g' |awk 'BEGIN{{FS=" ";OFS="\t"}}{{print $1,$2,$3,$4"."$5"."$6}}'>{output.bed};"""

rule sort_pre_bed:
    input:
        pre_bed = os.path.join(ROADMAP_DATA_DIR, "roadmap_pre.bed"),
    output:
        pre_sortedk5_bed = os.path.join(ROADMAP_DATA_DIR, "roadmap_pre_sortedk5.bed"),
    threads: THREADS
    shell:
        """sort --parallel {threads} -k5 {input.pre_bed} -o {output.pre_sortedk5_bed}"""

rule merge:
    input:
        EID_metadata_tab=os.path.join(ROADMAP_DATA_DIR, "EID_metadata.tab"),
    output:
        pre_bed = os.path.join(ROADMAP_DATA_DIR, "roadmap_pre.bed"),
    shell:
        """find {ROADMAP_DATA_DIR}/raw -name "*.gz"  | while read F; do F2=$(basename "$F"); gunzip -c $F |awk  -v F2="$F2" 'BEGIN{{FS="\t";OFS="\t"}} {{print $1,$2,$3,F2}}' |awk 'BEGIN{{FS="[-.]";OFS="\t"}}{{print $1,$2,$3}}' |awk 'BEGIN{{FS="\t";OFS="\t"}} {{print $1,$2,$3,$5,$4,"Roadmap"}}' ; done >{output.pre_bed}"""

rule download:
    input:
        ROADMAP_URL_LIST = ROADMAP_URL_LIST
    output:
        EID_metadata_tab=os.path.join(ROADMAP_DATA_DIR, "EID_metadata.tab"),
        cell_type_sorted_tsv=os.path.join(ROADMAP_DATA_DIR, "cell_types_sorted.tsv"),
    threads: THREADS
    shell:
        """rm -rf {ROADMAP_DATA_DIR}/raw; mkdir -p {ROADMAP_DATA_DIR}/raw;
            cat {input.ROADMAP_URL_LIST} | xargs -n1 -P{threads} wget --directory-prefix={ROADMAP_DATA_DIR}/raw;
        wget http://egg2.wustl.edu/roadmap/data/byFileType/metadata/EID_metadata.tab --directory-prefix=$ROADMAP_DATA_DIR;
        cut -f1,4,7 {output.EID_metadata_tab} |tr  "." "_" | tr "-" "_" | tr A-Z a-z |awk 'BEGIN{{FS="\t";OFS="\t"}}{{print $1,$2"-"$3}}'  >{output.cell_type_sorted_tsv};
        sort {output.cell_type_sorted_tsv} -o {output.cell_type_sorted_tsv}"""

