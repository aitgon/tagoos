ANNOTATION_DATA=os.getenv('ANNOTATION_DATA')
ROADMAP_DATA_DIR = os.getenv('ROADMAP_DATA_DIR')
THREADS = int(os.getenv('THREADS'))

rule sort_bed:
    input:
        bed_unsorted=os.path.join(ROADMAP_DATA_DIR, "roadmap_unsorted.bed"),
    output:
        bed=os.path.join(ROADMAP_DATA_DIR, "roadmap.bed"),
    threads: THREADS
    shell:
        """sort -u -k1,1 -k2,2n --parallel {threads} {input.bed_unsorted} -o {output.bed}"""

rule join_bed_annotation:
    input:
        id_bed_sortedk4=os.path.join(ROADMAP_DATA_DIR, "roadmap_id_sortedk4.bed"),
        annotation_data_sortedk3=os.path.join(ROADMAP_DATA_DIR, "annotation_data_sortedk3.tsv"),
    output:
        bed_unsorted=os.path.join(ROADMAP_DATA_DIR, "roadmap_unsorted.bed"),
    shell:
        """join -1 4 -2 3 {input.id_bed_sortedk4} {input.annotation_data_sortedk3} |awk 'BEGIN{{OFS="\t"}}{{print $2,$3,$4,$8"."$7"-"$9"."$6}}' >{output.bed_unsorted}"""

rule sort_id_bed:
    input:
        id_bed=os.path.join(ROADMAP_DATA_DIR, "roadmap_id.bed"),
    output:
        id_bed_sortedk4=os.path.join(ROADMAP_DATA_DIR, "roadmap_id_sortedk4.bed"),
    threads: THREADS
    shell:
        """sort -u --parallel {THREADS} -k4,4 {input.id_bed} -o {output.id_bed_sortedk4}"""

rule gunzip_bed_gz:
    input:
        bed_gz_downloaded=os.path.join(ROADMAP_DATA_DIR, "bed_gz.downloaded"),
    output:
        id_bed=os.path.join(ROADMAP_DATA_DIR, "roadmap_id.bed"),
    params:
        bed_gz_dir=os.path.join(ROADMAP_DATA_DIR, "bed_gz"),
    shell:
        """ls {params.bed_gz_dir} |while read F; do export FN=$F; export ID="${{FN%.bed.gz}}"; gunzip -c {params.bed_gz_dir}/$FN |awk -v ID="${{ID}}" 'BEGIN{{OFS="\t"}}{{print $1,$2,$3,ID}}'; done >{output.id_bed}"""

rule download_bed_gz:
    input:
        annotation_data_sortedk3=os.path.join(ROADMAP_DATA_DIR, "annotation_data_sortedk3.tsv"),
    params: bed_gz_data_dir=os.path.join(ROADMAP_DATA_DIR, "bed_gz")
    threads: THREADS
    output:
        bed_gz_downloaded=os.path.join(ROADMAP_DATA_DIR, "bed_gz.downloaded"),
    shell:
        """mkdir -p {params.bed_gz_data_dir}; cat /cobelix/gonzalez/data/2015_svmgwas/data/annotation_ngs_based/roadmap/annotation_data_sortedk3.tsv |cut -f1,3 |xargs -P{threads} -n2 sh -c 'wget "$0" -O {params.bed_gz_data_dir}/"$1".bed.gz';
            touch {output.bed_gz_downloaded}"""

rule grep_sort_experiment_list:
    input:
        annotation_data=ANNOTATION_DATA
    output:
        annotation_data_sortedk3=os.path.join(ROADMAP_DATA_DIR, "annotation_data_sortedk3.tsv"),
    shell:
        """grep roadmap {input.annotation_data} |sort -u -k3,3 -o {output.annotation_data_sortedk3}"""

