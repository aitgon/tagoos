ANNOTATION_DATA=os.getenv('ANNOTATION_DATA')
GTEX_DATA_DIR = os.getenv('GTEX_DATA_DIR')
THREADS = int(os.getenv('THREADS'))

rule sort_bed:
    input:
        bed_unsorted=os.path.join(GTEX_DATA_DIR, "gtex_unsorted.bed"),
    output:
        bed=os.path.join(GTEX_DATA_DIR, "gtex.bed"),
    threads: THREADS
    shell:
        """sort -u -k1,1 -k2,2n --parallel {threads} {input.bed_unsorted} -o {output.bed}"""

rule join_bed_annotation:
    input:
        id_bed=os.path.join(GTEX_DATA_DIR, "gtex_id_sortedk4.bed"),
        annotation_data=os.path.join(GTEX_DATA_DIR, "annotation_data_sortedk3.tsv"),
    output:
        bed_unsorted=os.path.join(GTEX_DATA_DIR, "gtex_unsorted.bed"),
    shell:
        """join -1 4 -2 3 {input.id_bed} {input.annotation_data} |awk 'BEGIN{{OFS="\t"}}{{print $2,$3,$4,$8"."$7"-"$9"."$6}}' >{output.bed_unsorted}"""

rule sort_id_bed:
    input:
        id_bed=os.path.join(GTEX_DATA_DIR, "gtex_id.bed"),
    output:
        id_bed=os.path.join(GTEX_DATA_DIR, "gtex_id_sortedk4.bed"),
    threads: THREADS
    shell:
        """sort -u --parallel {THREADS} -k4,4 {input.id_bed} -o {output.id_bed}"""

rule gunzip:
    input:
        annotation_data_sortedk3=os.path.join(GTEX_DATA_DIR, "annotation_data_sortedk3.tsv"),
    output:
        id_bed=os.path.join(GTEX_DATA_DIR, "gtex_id.bed"),
    params:
        GTEx_Analysis_v6p_eQTL_dir=os.path.join(GTEX_DATA_DIR, "GTEx_Analysis_v6p_eQTL"),
    shell:
        """cat {input.annotation_data_sortedk3} |cut -f3,3 |while read LABEL; do FN=$LABEL; gunzip -c {params.GTEx_Analysis_v6p_eQTL_dir}/${{LABEL}}_Analysis.v6p.signif_snpgene_pairs.txt.gz |awk -v LABEL="$LABEL" 'BEGIN{{OFS="\t";FS="_"}}NR>1{{print "chr"$1,$2-1,$2,LABEL}}'; done >{output.id_bed}"""

rule untar:
    input:
        tar=os.path.join(GTEX_DATA_DIR, "GTEx_Analysis_v6p_eQTL.tar"),
    params: gtex_dir=os.path.join(GTEX_DATA_DIR, "GTEx_Analysis_v6p_eQTL")
    threads: THREADS
    output:
        txt_gz_untared=os.path.join(GTEX_DATA_DIR, "txt_gz.untared"),
    shell:
        """tar xvf {input.tar}; touch {output.txt_gz_untared}"""

rule download_tar:
    input:
        annotation_data=os.path.join(GTEX_DATA_DIR, "annotation_data.tsv"),
    params: gtex_data_dir=GTEX_DATA_DIR
    output:
        tar=os.path.join(GTEX_DATA_DIR, "GTEx_Analysis_v6p_eQTL.tar"),
    shell:
        """wget http://www.gtexportal.org/static/datasets/gtex_analysis_v6p/single_tissue_eqtl_data/GTEx_Analysis_v6p_eQTL.tar --directory-prefix={params.gtex_data_dir};"""

rule grep_sort_experiment_list:
    input:
        annotation_data=ANNOTATION_DATA
    output:
        annotation_data_sortedk3=os.path.join(GTEX_DATA_DIR, "annotation_data_sortedk3.tsv"),
    shell:
        """grep gtex {input.annotation_data} |sort -u -k1,1 -o {output.annotation_data_sortedk3}"""

