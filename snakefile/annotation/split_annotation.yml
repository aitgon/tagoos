CHROM=os.getenv('CHROM').split()
ANNOT_1COL_BED=os.getenv('ANNOT_1COL_BED')
ANNOT_LABEL=os.getenv('ANNOT_LABEL')
THREADS=int(os.getenv('THREADS'))

from os.path import dirname
ANNOT_1COL_DIR = dirname(ANNOT_1COL_BED)

rule all:
    input:
        variable_txt = os.path.join(ANNOT_1COL_DIR, "variable.txt"),
        annot_chrom_bed = expand(os.path.join(ANNOT_1COL_DIR, "chrom/{chr}/%s.bed"%ANNOT_LABEL), chr=CHROM),

rule variable_txt:
    input:
        annot_bed = ANNOT_1COL_BED
    output:
        variable_txt = os.path.join(ANNOT_1COL_DIR, "variable.txt")
    threads: 8
    shell:
        """cut -f4,4 {input.annot_bed} >{output.variable_txt}; LC_ALL=C sort --parallel {threads} -u {output.variable_txt} -o {output.variable_txt}"""

rule sort:
    input:
        annot_chrom_bed = os.path.join(ANNOT_1COL_DIR, "chrom/{chr}/%s_nonsorted.bed"%ANNOT_LABEL)
    output:
        annot_chrom_bed = os.path.join(ANNOT_1COL_DIR, "chrom/{chr}/%s.bed"%ANNOT_LABEL)
    threads: THREADS
    shell:
        """LC_ALL=C sort --parallel {threads} -k1,1 -k2,2n {input.annot_chrom_bed} -o {output.annot_chrom_bed}"""

rule grep:
    input:
        annot_bed = ANNOT_1COL_BED
    params:
        chr = "chr{chr}"
    output:
        annot_chrom_bed = os.path.join(ANNOT_1COL_DIR, "chrom/{chr}/%s_nonsorted.bed"%ANNOT_LABEL)
    shell:
        """LC_ALL=C grep -w -P "^{params.chr}" {input.annot_bed} >{output.annot_chrom_bed}"""

