# Snakemake file

CHROM=os.getenv('CHROM').split()
DBSNP_DIR=os.getenv('DBSNP_DIR')
DBSNP_OUT_DIR=os.getenv('DBSNP_OUT_DIR')
HOME = os.getenv('HOME')
THREADS = int(os.getenv('THREADS'))
GENOMIC_REGION_BED = os.getenv('GENOMIC_REGION_BED')

rule all:
    input:
        expand(os.path.join(DBSNP_OUT_DIR, "chrom/{chr}/chr{chr}.bed.f4.idx"), chr=CHROM),

#rule intersect_chrom:
#    input:
#        snp_bed="chrom/{chr}/chr{chr}.bed",
#        annot_bed = os.path.join(HOME, "data/2015_svmgwas/data/annotation_ngs_based/%s/chrom/{chr}/%s_1col.bed"%(ANNOT_LABEL, ANNOT_LABEL)),
#    output:
#        annotated_tsv = os.path.join("chrom/{chr}/%s/intersect.tsv"%ANNOT_LABEL)
#    shell: """intersectBed -sorted -a {input.snp_bed} -b {input.annot_bed} -wb |awk '{{print $4"\t"$8}}' |sort -u -o {output.annotated_tsv}"""

rule bed_index:
    input:
        bed = os.path.join(DBSNP_OUT_DIR, "chrom/{chr}/chr{chr}.bed"),
    output:
        bed_idx=os.path.join(DBSNP_OUT_DIR, "chrom/{chr}/chr{chr}.bed.f4.idx")
    shell:
        """{HOME}/data/2015_svmgwas/data/hcomp/build_index -sr="" -r="" -fs="\t" -f=4 {input.bed} >{output.bed_idx}"""

rule intergenic_dbsnp:
    input:
        bed = os.path.join(DBSNP_DIR, "raw_bed/{chr}/chr{chr}.sorted.bed"),
        genomic_region_bed = GENOMIC_REGION_BED,
    output:
        bed = os.path.join(DBSNP_OUT_DIR, "chrom/{chr}/chr{chr}.bed"),
    shell:
        """bedtools intersect -sorted -a {input.bed} -b {input.genomic_region_bed} | sort -u -k1,1 -k2,2n >{output.bed}"""

#rule regional_peak_bed:
#    input:
#        peak_bed = os.path.join(GENOME1K_DIR, "peak_bed/{chr}/chr{chr}_peak.bed"),
#        genomic_region_bed = GENOMIC_REGION_BED,
#    output:
#        regional_peak_bed = os.path.join(GENOME1K_OUT_DIR, "peak_bed/chrom/{chr}/chr{chr}.bed"),
#    shell:
#        """bedtools intersect --sorted -a {input.peak_bed} -b {input.genomic_region_bed} | sort -u -k1,1 -k2,2n >{output.regional_peak_bed}"""


rule sort_bed:
    input:
        bed=os.path.join(DBSNP_DIR, "raw_bed/{chr}/chr{chr}.bed")
    output:
        bed=os.path.join(DBSNP_DIR, "raw_bed/{chr}/chr{chr}.sorted.bed")
    threads: THREADS
    shell:
        """LC_ALL=C sort -k1,1 -k2,2n --parallel {threads} {input.bed} -o {output.bed}"""

rule gunzip_bed:
    input:
        bed_gz=os.path.join(DBSNP_DIR, "raw/bed_chr_{chr}.bed.gz")
    output:
        bed=os.path.join(DBSNP_DIR, "raw_bed/{chr}/chr{chr}.bed")
    shell:
        """gunzip {input.bed_gz} -c |cut -f1,2,3,4 |awk -F"\t" '$1 ~ /^chr[[:digit:]]+$/ && $2 ~ /^[[:digit:]]+$/ && $3 ~ /^[[:digit:]]+$/' > {output.bed}"""

rule download_bed:
    output:
        bed_gz=os.path.join(DBSNP_DIR, "raw/bed_chr_{chr}.bed.gz")
    params:
        url="ftp://ftp.ncbi.nih.gov/snp/organisms/human_9606_b149_GRCh37p13/BED/bed_chr_{chr}.bed.gz"
    shell:
        """wget {params.url} -O {output.bed_gz}"""

