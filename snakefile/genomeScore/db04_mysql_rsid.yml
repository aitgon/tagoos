OUTDIR=os.getenv('OUTDIR')
HOME=os.getenv('HOME')
TAGOOS=os.getenv('TAGOOS')

DB_ID=os.getenv('DB_ID').split()
REGION=os.getenv('REGION')

DB_HOST=os.getenv('DB_HOST')
DB_PORT=os.getenv('DB_PORT')
DB_SERVER=os.getenv('DB_SERVER')

rule d099_mysql:
    input:
        expand(os.path.join(OUTDIR, "rsid_splitted/rsid_{region}_{db_id}.touched"), db_id=sorted(DB_ID), region=REGION),

rule d099_all:
    input:
        expand(os.path.join(OUTDIR, "rsid_splitted/rsid_{region}_{db_id}.touched"), db_id=sorted(DB_ID), region=REGION),
        expand(os.path.join(OUTDIR, "rsid_splitted/rsid_%s_{db_id}.sql.gz"%REGION), db_id=sorted(DB_ID)),

rule d02_dump:
    input:
        db=os.path.join(OUTDIR, "rsid_splitted/rsid_%s_{db_id}.touched"%REGION),
    output:
        sql_gz=os.path.join(OUTDIR, "rsid_splitted/rsid_%s_{db_id}.sql.gz"%REGION),
    params:
        db_id="{db_id}",
        region=REGION,
        db_host=DB_HOST,
        db_port=DB_PORT,
    shell:
        """mysqldump -h {params.db_host} -P {params.db_port} -u root -p'mypass' rsid_{params.region}_{params.db_id} |gzip >{output.sql_gz};"""

rule d01_mysql1:
    input:
        wopfile=os.path.join(TAGOOS, 'snakefile/genomeScore', "Wopfile.yml"),
        annotation_tsv=os.path.join(OUTDIR, "rsid_splitted/%s_{db_id}.tsv"%REGION),
    output:
        db=os.path.join(OUTDIR, "rsid_splitted/rsid_{region}_{db_id}.touched"),
    params:
        db_id="{db_id}",
        region=REGION,
        db_host=DB_HOST,
        db_port=DB_PORT,
        db_server=DB_SERVER,
    resources: db=1
    shell:
        """export DBSNP_TSV={input.annotation_tsv};
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -e 'drop database if exists rsid_{params.region}_{params.db_id};'
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -e 'create database if not exists rsid_{params.region}_{params.db_id};'
        {HOME}/Software/miniconda3/envs/tagoos/bin/wopmars -w {input.wopfile} -D "{params.db_server}/rsid_{params.region}_{params.db_id}?charset=utf8&local_infile=1" -d $PWD -v -p -F -t rule2 -n
        if [[ -s {input.annotation_tsv} ]];
        then
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -D rsid_{params.region}_{params.db_id} -e 'LOAD DATA LOCAL INFILE "{input.annotation_tsv}" INTO TABLE DBSNP (chrom, start_hg19, start_hg38, rsid, annotation, pval, neglogpval, gene, gene_distance);'
        fi;
        date;
        touch {output.db}"""


