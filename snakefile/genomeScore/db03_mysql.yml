OUTDIR=os.getenv('OUTDIR')
HOME=os.getenv('HOME')
TAGOOS=os.getenv('TAGOOS')

CHROM=os.getenv('CHROM').split()
REGION=os.getenv('REGION')

DB_HOST=os.getenv('DB_HOST')
DB_PORT=os.getenv('DB_PORT')
DB_SERVER=os.getenv('DB_SERVER')

rule d099_mysql:
    input:
        expand(os.path.join(OUTDIR, "chrom/{chr}/mysql.touched"), chr=CHROM),

rule d098_all:
    input:
        expand(os.path.join(OUTDIR, "chrom/{chr}/mysql.touched"), chr=CHROM),
        expand(os.path.join(OUTDIR, "%s_{chr}.sql.gz"%REGION), chr=CHROM),

rule d02_dump:
    input:
        db=os.path.join(OUTDIR, "chrom/{chr}/mysql.touched"),
    output:
        sql_gz=os.path.join(OUTDIR, "%s_{chr}.sql.gz"%REGION),
    params:
        chr="{chr}",
        region=REGION,
    shell:
        """mysqldump -h {params.db_host} -P {params.db_port} -u root -p'mypass' {params.region}_{params.chr} |gzip >{output.sql_gz};"""

rule d01_mysql1:
    input:
        wopfile=os.path.join(TAGOOS, 'snakefile/genomeScore', "Wopfile.yml"),
        annotation_tsv=os.path.join(OUTDIR, "chrom/{chr}/annotation_score_pval_gene_genedistance_hg19_hg38_chrom_window.tsv"),
    output:
        db=os.path.join(OUTDIR, "chrom/{chr}/mysql.touched"),
    params:
        chr="{chr}",
        region=REGION,
        db_host=DB_HOST,
        db_port=DB_PORT,
        db_server=DB_SERVER,
    resources: db=1
    shell:
        """export ANNOTATION_TSV={input.annotation_tsv};
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -e 'drop database if exists {params.region}_{params.chr};'
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -e 'create database if not exists {params.region}_{params.chr};'
        {HOME}/Software/miniconda3/envs/tagoos/bin/wopmars -w {input.wopfile} -D "{params.db_server}/{params.region}_{params.chr}?charset=utf8&local_infile=1" -d $PWD -v -p -F -t rule1 -n
        if [[ -s {input.annotation_tsv} ]];
        then 
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -D {params.region}_{params.chr} -e 'LOAD DATA LOCAL INFILE "{input.annotation_tsv}" INTO TABLE AnnotationWindow (chrom, start_hg19, end_hg19, start_hg38, end_hg38, annotation, score, pval, gene, gene_distance, start_hg19_chromosome_window, start_hg38_chromosome_window)'
        python {TAGOOS}/script/partition.py {params.chr} |mysql -uroot -pmypass  -h 10.1.1.157 intronic_22
        fi;
        date;
        touch {output.db}"""


