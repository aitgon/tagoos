OUTDIR=os.getenv('OUTDIR')
HOME=os.getenv('HOME')
TAGOOS=os.getenv('TAGOOS')

GENOME_WINDOW_IDS=os.getenv('GENOME_WINDOW_IDS').split()
REGION=os.getenv('REGION')

DB_HOST=os.getenv('DB_HOST')
DB_PORT=os.getenv('DB_PORT')
DB_SERVER=os.getenv('DB_SERVER')

rule d099_mysql:
    input:
        expand(os.path.join(OUTDIR, "gwindow/{gwindow}/mysql.touched"), gwindow=sorted(GENOME_WINDOW_IDS)),

rule d098_all:
    input:
        expand(os.path.join(OUTDIR, "gwindow/{gwindow}/mysql.touched"), gwindow=sorted(GENOME_WINDOW_IDS)),
        expand(os.path.join(OUTDIR, "%s_{gwindow}.sql.gz"%REGION), gwindow=sorted(GENOME_WINDOW_IDS)),

rule d02_dump:
    input:
        db=os.path.join(OUTDIR, "gwindow/{gwindow}/mysql.touched"),
    output:
        sql_gz=os.path.join(OUTDIR, "%s_{gwindow}.sql.gz"%REGION),
    params:
        gwindow="{gwindow}",
        region=REGION,
    shell:
        """mysqldump -h {params.db_host} -P {params.db_port} -u root -p'mypass' {params.region}_{params.gwindow} |gzip >{output.sql_gz};"""

rule d01_mysql1:
    input:
        wopfile=os.path.join(TAGOOS, 'snakefile/genomeScore', "Wopfile.yml"),
        annotation_tsv=os.path.join(OUTDIR, "gwindow/{gwindow}/annotation_score_gene_genedistance_hg19_hg38.tsv"),
    output:
        db=os.path.join(OUTDIR, "gwindow/{gwindow}/mysql.touched"),
    params:
        gwindow="{gwindow}",
        region=REGION,
        db_host=DB_HOST,
        db_port=DB_PORT,
        db_server=DB_SERVER,
    resources: db=1
    shell:
        """export ANNOTATION_TSV={input.annotation_tsv};
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -e 'drop database if exists {params.region}_{params.gwindow};'
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -e 'create database if not exists {params.region}_{params.gwindow};'
        {HOME}/Software/miniconda3/envs/tagoos/bin/wopmars -w {input.wopfile} -D "{params.db_server}/{params.region}_{params.gwindow}?charset=utf8&local_infile=1" -d $PWD -v -p -F -t rule1 -n
        if [[ -s {input.annotation_tsv} ]];
        then 
        mysql -h {params.db_host} -P {params.db_port} -u root -p'mypass' -D {params.region}_{params.gwindow} -e 'LOAD DATA LOCAL INFILE "{input.annotation_tsv}" INTO TABLE AnnotationWindow (chrom, start_hg19, end_hg19, start_hg38, end_hg38, annotation, score, gene, gene_distance)'
        fi;
        date;
        touch {output.db}"""


