ANNOT_LABEL = os.getenv('ANNOT_LABEL')
GENOME1K_DATA_DIR = os.getenv('GENOME1K_DATA_DIR')
HOME = os.getenv('HOME')
MODEL_PKL = os.getenv('MODEL_PKL')
OUTDIR = os.getenv('OUTDIR')
RSID_PATH = os.getenv('RSID_PATH')
SCRIPTDIR = os.getenv('SCRIPTDIR')
VARIABLE = os.getenv('VARIABLE')

CHROM=os.getenv('CHROM').split()

from os.path import basename, dirname

rule all:
    input:
        score_tsv = expand(os.path.join(OUTDIR, "chrom/{chr}/score.tsv"), chr=CHROM)
    output:
        all_score_tsv = os.path.join(OUTDIR, "score.tsv")
    shell:
        """export LC_ALL=C; sort -k2,2nr -k1,1 {input.score_tsv} >{output.all_score_tsv}"""

rule score:
    input:
        libsvm = os.path.join(OUTDIR, "chrom/{chr}/annotation.libsvm"),
        model_pkl = MODEL_PKL,
        script = os.path.join(SCRIPTDIR, "score.py"),
    output:
        score_tsv = os.path.join(OUTDIR, "chrom/{chr}/score.tsv"),
    shell:
        """%s/Software/miniconda3/envs/svmgwasappli3/bin/python {input.script} {input.libsvm} {input.model_pkl} {output.score_tsv}"""%HOME

rule to_libsvm:
    input:
        annotated_tsv = os.path.join(GENOME1K_DATA_DIR, "chr{chr}/intersect_%s/annotated.tsv"%ANNOT_LABEL),
        variable = VARIABLE,
        script = os.path.join(SCRIPTDIR, "tsv2libsvm_score.R"),
    output:
        libsvm = os.path.join(OUTDIR, "chrom/{chr}/annotation.libsvm"),
    shell:
        """Rscript {input.script} {input.annotated_tsv} {input.variable} {output.libsvm}"""

rule intersect_chrom:
    input:
        snp_bed = os.path.join(GENOME1K_DATA_DIR, "chr{chr}/chr{chr}.peak.bed"),
        annot_bed = os.path.join(HOME, "data/2015_svmgwas/data/annotation_ngs_based/%s/chrom/{chr}/%s_1col.bed"%(ANNOT_LABEL, ANNOT_LABEL)),
    output:
        annotated_tsv = os.path.join(GENOME1K_DATA_DIR, "chr{chr}/intersect_%s/annotated.tsv"%ANNOT_LABEL)
    shell: """intersectBed -sorted -a {input.snp_bed} -b {input.annot_bed} -wb |awk '{{print $4"\t"$8}}' >{output.annotated_tsv}"""

